name: Streamer

on:
  workflow_dispatch:
    inputs:
      file_name:
        description: 'Swift file to build'
        required: true
        type: string

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install XcodeGen
        run: brew install xcodegen
      
      - name: Create Project Files
        run: |
          mkdir -p MyApp/Sources/Assets.xcassets/AppIcon.appiconset
          mkdir -p MyApp/Sources/Assets.xcassets/AccentColor.colorset
          
          # Show original file
          echo "=== Original uploaded file ==="
          cat "Sources/${{ github.event.inputs.file_name }}" || echo "File not found"
          echo ""
          echo "================================"
          
          # Simple approach: Use sed to remove @main and the App struct
          if [ -f "Sources/${{ github.event.inputs.file_name }}" ]; then
            # Copy the file first
            cp "Sources/${{ github.event.inputs.file_name }}" MyApp/Sources/temp.swift
            
            # Remove @main line
            sed -i '' '/@main/d' MyApp/Sources/temp.swift
            
            # Remove the App struct (MyApp, SwiftIDEApp, etc.) - multiline removal with perl
            perl -i -p0e 's/struct\s+\w+App\s*:\s*App\s*\{[^}]*\{[^}]*\}[^}]*\}//gs' MyApp/Sources/temp.swift
            
            # Also try simpler pattern for single-line or simple App structs
            perl -i -p0e 's/struct\s+\w+App\s*:\s*App\s*\{[^}]*\}//gs' MyApp/Sources/temp.swift
            
            # Remove any empty lines at the start
            sed -i '' '/^$/N;/^\n$/d' MyApp/Sources/temp.swift
            
            # Move to final location
            mv MyApp/Sources/temp.swift MyApp/Sources/ContentView.swift
            
            echo "=== Processed ContentView.swift ==="
            cat MyApp/Sources/ContentView.swift
            echo ""
            echo "================================"
          else
            cat > MyApp/Sources/ContentView.swift << 'SWIFT'
          import SwiftUI
          
          struct ContentView: View {
              var body: some View {
                  Text("Hello World")
              }
          }
          SWIFT
          fi
          
          # Verify ContentView struct exists
          if ! grep -q "struct ContentView" MyApp/Sources/ContentView.swift; then
            echo "ERROR: ContentView not found! Creating default..."
            cat > MyApp/Sources/ContentView.swift << 'SWIFT'
          import SwiftUI
          
          struct ContentView: View {
              var body: some View {
                  Text("Hello World - Default")
              }
          }
          SWIFT
          fi
          
          # Create App entry point
          cat > MyApp/Sources/MyAppApp.swift << 'SWIFT'
          import SwiftUI
          
          @main
          struct MyAppApp: App {
              var body: some Scene {
                  WindowGroup {
                      ContentView()
                  }
              }
          }
          SWIFT
          
          # Create Assets
          echo '{"info":{"version":1,"author":"xcode"}}' > MyApp/Sources/Assets.xcassets/Contents.json
          echo '{"images":[],"info":{"version":1,"author":"xcode"}}' > MyApp/Sources/Assets.xcassets/AppIcon.appiconset/Contents.json
          echo '{"colors":[{"idiom":"universal"}],"info":{"version":1,"author":"xcode"}}' > MyApp/Sources/Assets.xcassets/AccentColor.colorset/Contents.json
          
          # Create XcodeGen spec
          cat > MyApp/project.yml << 'YAML'
          name: MyApp
          options:
            bundleIdPrefix: com.swiftide
            deploymentTarget:
              iOS: "16.0"
          
          targets:
            MyApp:
              type: application
              platform: iOS
              sources:
                - Sources
              settings:
                base:
                  PRODUCT_BUNDLE_IDENTIFIER: com.swiftide.myapp
                  PRODUCT_NAME: MyApp
                  MARKETING_VERSION: "1.0"
                  CURRENT_PROJECT_VERSION: "1"
                  CODE_SIGN_IDENTITY: ""
                  CODE_SIGNING_REQUIRED: "NO"
                  CODE_SIGNING_ALLOWED: "NO"
                  INFOPLIST_KEY_UILaunchScreen_Generation: "YES"
                  INFOPLIST_KEY_UIApplicationSceneManifest_Generation: "YES"
                  GENERATE_INFOPLIST_FILE: "YES"
                  SWIFT_VERSION: "5.0"
                  ASSETCATALOG_COMPILER_APPICON_NAME: ""
                  ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS: "NO"
                  ONLY_ACTIVE_ARCH: "NO"
          YAML
          
          echo "=== Final MyAppApp.swift ==="
          cat MyApp/Sources/MyAppApp.swift
          echo ""
          echo "=== All source files ==="
          ls -la MyApp/Sources/

      - name: Generate Xcode Project
        run: |
          cd MyApp
          xcodegen generate

      - name: Build for Simulator
        run: |
          cd MyApp
          
          xcodebuild \
            -project MyApp.xcodeproj \
            -scheme MyApp \
            -sdk iphonesimulator \
            -configuration Debug \
            -derivedDataPath build \
            -arch x86_64 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ASSETCATALOG_COMPILER_APPICON_NAME="" \
            ONLY_ACTIVE_ARCH=NO \
            build 2>&1 | tee build.log
          
          # Check for build errors
          if grep -q "error:" build.log; then
            echo "=== BUILD ERRORS ==="
            grep "error:" build.log
            exit 1
          fi
          
          echo "Build complete!"
          find build -name "*.app" -type d

      - name: Verify App Bundle
        run: |
          APP_PATH=$(find MyApp/build -name "*.app" -type d | head -1)
          echo "App path: $APP_PATH"
          
          echo "=== App contents ==="
          ls -la "$APP_PATH"
          
          echo "=== Binary info ==="
          file "$APP_PATH/MyApp"
          lipo -info "$APP_PATH/MyApp"

      - name: Upload to Appetize
        env:
          APPETIZE_TOKEN: ${{ secrets.APPETIZE_TOKEN }}
        run: |
          APP_PATH=$(find MyApp/build -name "*.app" -type d | head -1)
          
          if [ -z "$APP_PATH" ]; then
            echo "No .app found!"
            exit 1
          fi
          
          cd "$(dirname "$APP_PATH")"
          zip -r app.zip "$(basename "$APP_PATH")"
          
          echo "Uploading to Appetize..."
          RESPONSE=$(curl -s "https://api.appetize.io/v1/apps/zvc4brtsspoktczlbrs54s3mhi?token=$APPETIZE_TOKEN" \
            -F "file=@app.zip" \
            -F "platform=ios")
          
          echo "Response:"
          echo "$RESPONSE"
