name: iOS Build
on:
  workflow_dispatch:
    inputs:
      ref:
        default: "main"
jobs:
  build:
    permissions: write-all
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install XcodeGen
        run: brew install xcodegen
        
      - name: Generate Project
        run: xcodegen generate
        
      - name: Build Archive
        run: |
          xcodebuild archive \
            -project S.xcodeproj \
            -scheme S \
            -destination "generic/platform=iOS" \
            -archivePath build/S.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
            
      - name: Export IPA (Unsigned)
        run: |
          mkdir -p Payload
          cp -r build/S.xcarchive/Products/Applications/S.app Payload/
          zip -r S.ipa Payload
          
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_id }}
          files: S.ipa
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}