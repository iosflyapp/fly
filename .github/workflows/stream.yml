name: Stream to iPad

on: workflow_dispatch

jobs:
  build-and-stream:
    runs-on: macos-latest  # <--- CHANGED THIS LINE
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 # Updated to v4 for better compatibility
      
      # STEP 1: Build specifically for the Simulator architecture
      # REMEMBER: Change 'SwiftIDE' below to your actual scheme name if it's different!
      - name: Build for Simulator
        run: |
          xcodebuild build \
            -scheme "SwiftIDE" \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            -configuration Debug \
            -derivedDataPath build
            
      # STEP 2: Zip the App Bundle
      - name: Zip the Build
        run: |
          cd build/Build/Products/Debug-iphonesimulator/
          zip -r app_build.zip *.app
          
      # STEP 3: Upload to Appetize.io
      - name: Upload to Streaming Server
        id: upload_step
        run: |
          # The -F "file=@..." flag sends the zip file
          # The response captures the JSON output from Appetize
          response=$(curl --request POST https://api.appetize.io/v1/apps \
            --header "Authorization: Basic ${{ secrets.APPETIZE_TOKEN }}" \
            --header 'Content-Type: application/json' \
            --data-raw '{ "platform": "ios", "fileType": "zip" }' \
            -F "file=@build/Build/Products/Debug-iphonesimulator/app_build.zip")
            
          echo "Upload complete!"
          
          # This helps you find the key in the logs
          echo "------------------------------------------------"
          echo "LOOK BELOW FOR YOUR PUBLIC KEY:"
          echo $response | grep -o '"publicKey":"[^"]*"'
          echo "------------------------------------------------"
