name: Stream to iPad

on: workflow_dispatch

jobs:
  build-and-stream:
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # STEP 1: Build for Simulator
      - name: Build for Simulator
        run: |
          # Find the directory containing the project file
          PROJECT_PATH=$(find . -name "*.xcodeproj" -o -name "Package.swift" | head -n 1 | xargs dirname)
          
          if [ -z "$PROJECT_PATH" ]; then
            echo "âŒ ERROR: No Xcode project or Package.swift found!"
            exit 1
          fi
          
          cd "$PROJECT_PATH"

          # Build the Scheme "SwiftIDE"
          xcodebuild build \
            -scheme "SwiftIDE" \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            -configuration Debug \
            -derivedDataPath build

      # STEP 2: Package and Zip (NEW FIX)
      - name: Package and Zip
        run: |
          # 1. Find the raw executable binary (It won't be a .app folder yet)
          # We look in the build folder for a file named "SwiftIDE"
          BINARY_PATH=$(find build/Build/Products/Debug-iphonesimulator -maxdepth 1 -type f -name "SwiftIDE" | head -n 1)
          
          if [ -z "$BINARY_PATH" ]; then
             echo "âŒ ERROR: Could not find raw executable 'SwiftIDE'"
             # Debug info if it fails
             ls -R build/Build/Products/Debug-iphonesimulator
             exit 1
          fi

          echo "âœ… Found binary at: $BINARY_PATH"
          
          # 2. Manually create the .app Folder Structure
          APP_NAME="SwiftIDE"
          APP_DIR="$APP_NAME.app"
          mkdir -p "$APP_DIR"
          
          # 3. Move the Binary into the .app folder
          cp "$BINARY_PATH" "$APP_DIR/$APP_NAME"
          
          # 4. Create a minimal Info.plist (Required for iOS to launch it)
          cat > "$APP_DIR/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>$APP_NAME</string>
              <key>CFBundleIdentifier</key>
              <string>com.iosfly.$APP_NAME</string>
              <key>CFBundleName</key>
              <string>$APP_NAME</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSRequiresIPhoneOS</key>
              <true/>
          </dict>
          </plist>
          EOF
          
          echo "ðŸ“¦ Created bundle: $APP_DIR"

          # 5. Zip it for Appetize
          zip -r app_build.zip "$APP_DIR"
          
          # Move to workspace root so next step finds it
          mv app_build.zip $GITHUB_WORKSPACE/app_build.zip

      # STEP 3: Upload to Appetize
      - name: Upload to Streaming Server
        id: upload_step
        run: |
          response=$(curl --request POST https://api.appetize.io/v1/apps \
            --header "Authorization: Basic ${{ secrets.APPETIZE_TOKEN }}" \
            --header 'Content-Type: application/json' \
            --data-raw '{ "platform": "ios", "fileType": "zip" }' \
            -F "file=@app_build.zip")
            
          echo "Upload complete!"
          echo "------------------------------------------------"
          echo "LOOK BELOW FOR YOUR PUBLIC KEY:"
          echo $response | grep -o '"publicKey":"[^"]*"'
          echo "------------------------------------------------"
